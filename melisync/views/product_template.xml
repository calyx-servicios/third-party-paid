<odoo>
  <data>
    <!-- Extendemos form view de product.template -->
    <record model="ir.ui.view" id="melisync.product_template_inherit">
      <field name="name">MercadoLibre product template inherit</field>
      <field name="model">product.template</field>
      <field name="inherit_id" ref="product.product_template_only_form_view"/>
      <field name="type">form</field>
      <field name="arch" type="xml">
        <div name="button_box" position="after">
          <field name="meli_publications" attrs="{ 'invisible': True }" />
          <div class="oe_button_box" name="button_box_2" attrs="{ 'invisible': ['|', ('meli_publications', '=', []), ('meli_ready', '=', False)]}" groups="melisync.res_groups_products_moderator">
              <button type="object" name="meli_button_publish" string="ML Publish" help="Publish on MercadoLibre." class="oe_stat_button text-success" icon="fa-play" />
              <button type="object" name="meli_button_sync" string="ML Sync" help="Synchronize on MercadoLibre." class="oe_stat_button text-alpha" icon="fa-spinner" />
              <button type="object" name="meli_button_reactivate" string="ML Reactivate" help="Reactivate product on MercadoLibre." class="oe_stat_button text-primary" icon="fa-play" />
              <button type="object" name="meli_button_pause" string="ML Pause" help="Pause product on MercadoLibre." class="oe_stat_button text-warning" icon="fa-pause" />
              <button type="object" name="meli_button_close" string="ML Close" help="Delete product on MercadoLibre." class="oe_stat_button text-danger" icon="fa-power-off" />
              <button type="object" name="meli_button_close_force" string="ML Force delete" help="Delete force product on MercadoLibre." class="oe_stat_button text-danger" icon="fa-times" groups="melisync.res_groups_administrator" />
          </div>
        </div>
        <!-- Remove variants by default -->
        <xpath expr="//page[@name='variants']//field[@name='attribute_line_ids']" position="after">
          <group string="MercadoLibre category attributes" attrs="{ 'invisible': [('meli_category', '=', False)]}">
            <field name="meli_category_attribute_ids" nolabel="1" attrs="{ 'invisible': [('meli_category_attribute_ids', '=', [])]}">
              <tree decoration-warning="is_required" default_order="is_required desc, meli_id asc" create="false" edit="false" delete="false" duplicate="0">
                <field name="is_required" attrs="{ 'column_invisible': True }" />
                <field name="meli_id" string="Attribute ID" />
                <field name="name" string="Attribute name" />
                <field name="tag_ids" string="Tags" widget="many2many_tags" />
              </tree>
            </field>
            <p colspan="2" attrs="{ 'invisible': [('meli_category_attribute_ids', '!=', [])]}">
              <strong>Note</strong>: You can synchronize the <button name="meli_button_category_sync_attributes" type="object" string="category attributes" class="oe_link"/> with this button.
            </p>
          </group>
        </xpath>
        <xpath expr="//page[@name='inventory']" position="after">
          <!-- Hidden fields-->
          <field name="meli_ready" attrs="{ 'invisible': True }" />
          <field name="meli_instance_site_id" attrs="{ 'invisible': True }" />
          <field name="meli_available_shipping_modes" attrs="{ 'invisible': True }" />
          <page name="mercadolibre" string="MercadoLibre" attrs="{ 'invisible': ['|', ('type', '!=', 'product')] }" groups="melisync.res_groups_products_moderator">
            <sheet>
              <group>
                <group string="Settings">
                  <field name="meli_instance" string="Site instance" attrs="{ 'readonly': [('meli_publications', '!=', [])] }" options="{ 'no_open': True, 'no_create': True, 'no_edit': True, 'no_create_edit': True }" />
                  <field name="meli_category" string="Category" domain="[('site_id', '=', meli_instance_site_id)]" attrs="{ 'readonly': [('meli_publications', '!=', [])], 'required': [('meli_instance', '!=', False)] }" options="{ 'no_create': True, 'no_edit': True, 'no_create_edit': True }" />
                  <label for="meli_category" string="Prediction" class="oe_edit_only" attrs="{ 'invisible': [('meli_instance', '=', False)] }" />
                  <div class="oe_edit_only" attrs="{ 'invisible': [('meli_instance', '=', False)] }">
                    <button name="meli_button_predict_category" type="object" string="auto predict category" class="oe_link"/>
                  </div>
                </group>
                <group>
                  <group string="Buying data" colspan="2">
                    <field name="meli_buying_mode" string="Buying mode" />
                    <field name="meli_condition" string="Product condition" />
                  </group>
                  <group string="Extra info" colspan="2">
                    <field name="meli_youtube_url" string="Youtube URL" />
                  </group>
                </group>
              </group>
              <group>
                <group string="Stock settings">
                  <field name="meli_warehouse_id" string="Warehouse" attrs="{ 'readonly': True, 'invisible': [('meli_instance', '=', False)] }" groups="melisync.res_groups_administrator" />
                  <field name="meli_available_qty" string="Available qty." attrs="{ 'readonly': True }" />
                </group>
                <group string="Shipping info" attrs="{ 'invisible': [('meli_instance', '=', False)] }">
                  <field
                    name="meli_shipping_mode"
                    string="Mode"
                    domain="[('id', 'in', meli_available_shipping_modes)]"
                    attrs="{ 'required': [('meli_instance', '!=', False)] }"
                    options="{ 'no_open': True, 'no_create_edit': True, 'no_create': True, 'no_edit': True }"
                  />
                  <field
                    name="meli_shipping_methods_free"
                    string="Free methods"
                    domain="[('shipping_modes', 'in', [meli_shipping_mode]), ('site_id', '=', meli_instance_site_id)]"
                    options="{ 'no_create_edit': True, 'no_create': True, 'no_edit': True }"
                    widget="many2many_tags"
                  />
                  <p class="oe_edit_only" colspan="2">
                    <strong>Note</strong>: You can sync the <button name="meli_get_instance_shipping_info" type="object" string="default shipping mode and methods" class="oe_link"/> with the settings instance config.
                  </p>
                  <field name="meli_local_pickup" string="Pick up locally" />
                </group>
              </group>
            </sheet>
          </page>
          <page name="mercadolibre" string="MercadoLibre publications" attrs="{ 'invisible': ['|', ('type', '!=', 'product'), ('meli_ready', '=', False)] }" groups="melisync.res_groups_products_moderator">
            <group string="Publications">
              <field name="meli_publications" nolabel="1" context="{ 'default_product_id': id }">
                <tree editable="bottom">
                  <field name="user_is_meli_administrator" attrs="{ 'column_invisible': True }" />
                  <field name="site_id" attrs="{ 'column_invisible': True }" />
                  <field name="product_id" attrs="{ 'column_invisible': True }" />
                  <field name="available_pricelists" attrs="{ 'column_invisible': True }" />
                  <field name="product_available_qty" attrs="{ 'column_invisible': True }" />
                  <field name="listing_type" domain="[('site_id', '=', site_id)]" options="{ 'no_open': True, 'no_create_edit': True }" />
                  <field name="pricelist" domain="[('id', 'in', available_pricelists)]" options="{ 'no_open': True, 'no_create': True, 'no_edit': True, 'no_create_edit': True }" />
                  <field name="status" string="Status" attrs="{ 'readonly': [('user_is_meli_administrator', '=', False)] }" />
                  <field name="available_qty" string="Total stock" attrs="{ 'readonly': True }" />
                  <field name="price" attrs="{ 'readonly': True }" />
                  <field name="publication_id" attrs="{ 'readonly': [('user_is_meli_administrator', '=', False)] }" />
                </tree>
              </field>
            </group>
          </page>
        </xpath>
      </field>
    </record>
    <!-- Add tree views of products. -->
    <record model="ir.ui.view" id="melisync.product_template_tree">
      <field name="name">MercadoLibre product template view tree</field>
      <field name="model">product.template</field>
      <field name="type">tree</field>
      <field name="arch" type="xml">
        <tree duplicate="0" >
          <field name="name" />
          <field name="categ_id" string="Category" />
          <field name="meli_category" string="MercadoLibre category" />
          <field name="meli_available_qty" string="Stock" />
        </tree>
      </field>
    </record>
    
    <!-- search view definition -->
    <record model="ir.ui.view" id="melisync.product_search_view">
        <field name="name">MercadoLibre product.template Search View</field>
        <field name="model">product.template</field>
        <field name="arch" type="xml">
            <search string="Search product">
                <field string="Name" name="name" domain="[('name', 'ilike', self)]"/>
                <field string="Barcode" name="barcode" domain="[('barcode', 'ilike', self)]"/>
                <field string="MercadoLibre category" name="meli_category" domain="[('meli_category', 'ilike', self)]"/>
                <field string="MercadoLibre instance" name="meli_instance" domain="[('meli_instance.name', 'ilike', self)]"/>
                <field string="MercadoLibre buying mode" name="meli_buying_mode" domain="[('meli_buying_mode', 'ilike', self)]"/>
                <field string="MercadoLibre condition" name="meli_condition" domain="[('meli_condition', 'ilike', self)]"/>
                <field string="MercadoLibre youtube video" name="meli_youtube_url" domain="[('meli_youtube_url', 'ilike', self)]"/>
                <separator />
                <group expand="0" name="group_by" string="Group by">
                    <filter string="Local category" name="categ_id" context="{'group_by': 'categ_id' }" />
                    <filter string="MercadoLibre category" name="meli_category" context="{'group_by': 'meli_category' }" />
                    <filter string="MercadoLibre instance" name="meli_instance" context="{'group_by': 'meli_instance' }" />
                    <filter string="MercadoLibre buying mode" name="meli_buying_mode" context="{'group_by': 'meli_buying_mode' }" />
                    <filter string="MercadoLibre condition" name="meli_condition" context="{'group_by': 'meli_condition' }" />
                    <filter string="MercadoLibre local pickup" name="meli_free_local_pickup" context="{'group_by': 'meli_local_pickup' }" />
                </group>
            </search>
        </field>
    </record>
    <!-- Published products -->
    <record id="melisync.menu_products_processed_action" model="ir.actions.act_window">
      <field name="name">Processed products</field>
      <field name="res_model">product.template</field>
      <field name="view_mode">tree,form</field>
      <field name="view_id" ref="melisync.product_template_tree"/>
      <field name="type">ir.actions.act_window</field>
      <field name="domain">[('meli_ready', '=', True)]</field>
      <field name="search_view_id" ref="melisync.product_search_view" />
    </record>
    <!-- Unpublished products -->
    <record id="melisync.menu_products_non_processed_action" model="ir.actions.act_window">
      <field name="name">Non processed products</field>
      <field name="res_model">product.template</field>
      <field name="view_mode">tree,form</field>
      <field name="view_id" ref="melisync.product_template_tree"/>
      <field name="type">ir.actions.act_window</field>
      <field name="domain">[('meli_ready', '=', False)]</field>
      <field name="search_view_id" ref="melisync.product_search_view" />
    </record>
    <!-- Menu items -->
    <menuitem name="Processed" parent="melisync.menu_products" id="melisync.menu_products_processed" action="melisync.menu_products_processed_action" groups="melisync.res_groups_products_moderator" sequence="0"/>
    <menuitem name="For process" parent="melisync.menu_products" id="melisync.menu_products_non_processed" action="melisync.menu_products_non_processed_action" groups="melisync.res_groups_products_moderator" sequence="1"/>
  </data>
</odoo>